<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="">
        <script>
            function fetchJSONData() {
                return fetch("http://127.0.0.1:5000/")
                    .then((res) => {
                        if (!res.ok) {
                            throw new Error
                                (`HTTP error! Status: ${res.status}`);
                        }
                        return res.json();
                    })
                    .catch((error) => 
                           console.error("Unable to fetch data:", error));
            }
            var items
            var types
            var tags
            var recipies

            function on_load() {
                json_data = fetchJSONData().then((data) => {
                    load_recipe(data)
                    set_items_html(data)
                });
            }
            function load_types(json){
                if(types){
                    return types
                }
                types = {}
                types_json = load_json_to_dict("Type", "name", json)
                Object.keys(types_json).forEach((key)=>{
                    types[key] = new ItemType(types_json[key].name, types_json[key].parent, types_json[key].tobuy_rank_multiplier)
                })
                Object.keys(types).forEach((key)=>{
                    if ("string" == typeof types[key].parent) {
                        types[key].parent = types[types[key].parent]
                    }
                })
                return types
            }
            function load_items(json){
                if(items){
                    return items
                }
                items_json = load_json_to_dict("Item", "name", json)
                types = load_types(json)
                Object.keys(items_json).forEach((key)=>{
                    items_json[key].type = types[items_json[key].type]
                })
                items = {}
                Object.keys(items_json).forEach((key)=>{
                    items[key] = new Item(items_json[key].name, items_json[key].type, items_json[key].tobuy_rank_multiplyer, items_json[key].allergen)
                })
                return items
            }
            function load_items_to_recipe(json){
                load_items(json)
                item_recipe_json = load_json_to_nested_dict("ItemToRecipe", "recipe", "item", json)
                result = {}
                Object.keys(item_recipe_json).forEach((r)=>{
                    if(!(r in Object.keys(item_recipe_json[r]))){
                        result[r] = {}
                    }
                    Object.keys(item_recipe_json[r]).forEach((i)=>{
                        result[r][i] = new ItemToRecipe(r, items[i], item_recipe_json[r][i].missing, item_recipe_json[r][i].amount, item_recipe_json[r][i].measurment)
                    })
                })
                return result
            }
            function load_recipe(json){
                if(recipies){
                    return recipies
                }
                items_to_recipy = load_items_to_recipe(json)
                recipe_json = load_json_to_dict("Recipe","name", json)
                steps = load_json_to_nested_dict("Step", "recipe", "step_nr", json)
                tags = load_json_to_nested_dict("RecipeTag", "recipe", "tag", json)
                var recipies = []
                Object.keys(recipe_json).forEach((key)=>{
                    recipies.push(new Recipe(key, items_to_recipy[key], steps[key], Object.keys(tags[key])))
                })
                return recipies
            }
            function set_items_html(json){
                items = load_items(json)
                items_div = document.getElementById("items")
                Object.keys(items).forEach((key) => {
                    items_div.append(items[key].make_div())
                })
            }
            function load_json_to_dict(obj_name, id, json){
                result = {}
                arr = json[obj_name]
                for (let i = 0; i < Object.keys(arr).length; i++) {
                    obj = {}
                    Object.keys(arr[i]).forEach((value) => {
                        obj[value] = arr[i][value]
                    })
                    result[arr[i][id]] = obj
                }
                return result
            }
            function load_json_to_nested_dict(obj_name, id1, id2, json){
                result = {}
                arr = json[obj_name]
                for (let i = 0; i < Object.keys(arr).length; i++) {
                    obj = {}
                    Object.keys(arr[i]).forEach((value) => {
                        obj[value] = arr[i][value]
                    })
                    if(!(result[arr[i][id1]])){
                        result[arr[i][id1]] = {}
                    }
                    result[arr[i][id1]][arr[i][id2]] = obj
                }
                return result
            }
            class Recipe{
                constructor(name, items, steps, tags){
                    this.name = name
                    this.items = items
                    this.steps = steps
                    this.tags = tags
                }

                get_rating(){
                    return 1
                }
            }
            class ItemToRecipe{
                constructor(recipe, item, missing, amount, measurment){
                    this.recipe = recipe
                    this.item = item
                    this.missing = missing
                    this.amount = amount
                    this.measurment = measurment
                }
            }
            class ItemType{
                constructor(name, parent, toBuy){
                    this.name = name
                    this.parent = parent
                    this.toBuy = toBuy
                }
                get_toBuy(){
                    var result = this.toBuy
                    var type = this.parent
                    while(result == null){
                        if(type == null || typeof type == "string"){
                            return 0
                        }
                        result = type.toBuy
                        type = type.parent
                    }
                    return result
                }

                toString(){
                    if(this.parent){
                        return this.parent + ", " + this.name
                    }
                    return this.name
                }
            }
            class Item{
                
                constructor(name, type, toBuy, allergen){
                    this.name = name
                    this.type = type
                    this.toBuy = toBuy
                    this.allergen = allergen
                    this.available = true
                    this.custom_multiplier = 1
                }

                get_toBuy(){
                    if (this.toBuy){
                        return this.toBuy
                    }
                    if (this.type){
                        return this.type.get_toBuy()
                    }
                    return 0
                }

                make_div(){
                    var div = document.createElement("div")
                    div.id = "item_"+this.name
                    div.class = "item_container"
                    div.style = "border: solid 2px black;"

                    var name_p = document.createElement("p")
                    name_p.id = div.id+"_name"
                    name_p.class = "item_value"
                    name_p.innerText = this.name
                    if(this.allergen){
                        name_p.innerText += " (" + this.allergen + ")"
                    }
                    div.append(name_p)
                    /*
                    var type_p = document.createElement("p")
                    type_p.id = div.id+"_type"
                    type_p.class = "item_value"
                    type_p.innerText = this.type
                    div.append(type_p)

                    var toBuy_p = document.createElement("p")
                    toBuy_p.id = div.id+"_toBuy"
                    toBuy_p.class = "item_value"
                    toBuy_p.innerText = this.get_toBuy()
                    div.append(toBuy_p)

                    var allergen_p = document.createElement("p")
                    allergen_p.id = div.id+"_allergen"
                    allergen_p.class = "item_value"
                    allergen_p.innerText = this.allergen
                    div.append(allergen_p)
                    */

                    var available_label = document.createElement("label")
                    available_label.innerText = "Available"
                    available_label.class = "switch"
                    var available_input = document.createElement("input")
                    available_input.type = "checkbox"
                    available_input.onchange = "function(){console.log(" + this.name + ")}"
                    available_label.append(available_input)
                    div.append(available_label)

                    return div
                }
            }
        </script>
    </head>
    <body onload="on_load()">
        <div id="items">

        </div>
    </body>
</html>