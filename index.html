<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="style.css">
        <script>
            function fetchJSONData() {
                return fetch("http://127.0.0.1:5000/")
                    .then((res) => {
                        if (!res.ok) {
                            throw new Error
                                (`HTTP error! Status: ${res.status}`);
                        }
                        return res.json();
                    })
                    .catch((error) => 
                           console.error("Unable to fetch data:", error));
            }
            var items
            var types
            var tags
            var recipies

            function on_load() {
                json_data = fetchJSONData().then((data) => {
                    set_items_html(data)
                    load_recipes(data)
                    set_recepies_html(data)
                });
            }
            function get_store_available(){
                return document.getElementById("store_available").checked
            }
            function load_types(json){
                if(types){
                    return types
                }
                types = {}
                types_json = load_json_to_dict("Type", "name", json)
                Object.keys(types_json).forEach((key)=>{
                    types[key] = new ItemType(types_json[key].name, types_json[key].parent, types_json[key].tobuy_rank_multiplier)
                })
                Object.keys(types).forEach((key)=>{
                    if ("string" == typeof types[key].parent) {
                        types[key].set_parent(types[types[key].parent])
                    }
                })
                return types
            }
            function load_items(json){
                load_types(json)
                if(items){
                    return items
                }
                items_json = load_json_to_dict("Item", "name", json)
                
                Object.keys(items_json).forEach((key)=>{
                    items_json[key].type = types[items_json[key].type]
                })
                items = {}
                Object.keys(items_json).forEach((key)=>{
                    items[key] = new Item(items_json[key].name, items_json[key].type, items_json[key].tobuy_rank_multiplyer, items_json[key].allergen)
                })
                return items
            }
            function load_items_to_recipe(json){
                load_items(json)
                item_recipe_json = load_json_to_nested_dict("ItemToRecipe", "recipe", "item", json)
                result = {}
                Object.keys(item_recipe_json).forEach((r)=>{
                    if(!(r in Object.keys(item_recipe_json[r]))){
                        result[r] = {}
                    }
                    Object.keys(item_recipe_json[r]).forEach((i)=>{
                        result[r][i] = new ItemToRecipe(r, items[i], item_recipe_json[r][i].missing_rank_multiplier, item_recipe_json[r][i].amount, item_recipe_json[r][i].measurement)
                    })
                })
                return result
            }
            function load_recipes(json){
                if(recipies){
                    return recipies
                }
                items_to_recipy = load_items_to_recipe(json)
                recipe_json = load_json_to_dict("Recipe","name", json)
                steps = load_json_to_nested_dict("Step", "recipe", "step_nr", json)
                tags = load_json_to_nested_dict("RecipeTag", "recipe", "tag", json)
                recipies = []
                Object.keys(recipe_json).forEach((key)=>{
                    recipies.push(new Recipe(key, items_to_recipy[key], steps[key], Object.keys(tags[key])))
                })
                return recipies
            }
            function set_items_html(json){
                load_items(json)
                items_div = document.getElementById("items")
                Object.values(types).forEach((type) => {
                    if(type.parent == null){
                        document.getElementById("items").append(type.make_div())
                    }
                })
            }
            function set_recepies_html(json){
                if(json){
                    load_recipes(json)
                }
                if(recipies){
                    recipies.sort(function compare(a,b){return b.get_rating()-a.get_rating()})
                    var recipe_container = document.getElementById("recipes")
                    recipe_container.innerHTML = ""
                    recipies.forEach((r)=>{recipe_container.append(r.make_div())})
                }
            }
            function load_json_to_dict(obj_name, id, json){
                result = {}
                arr = json[obj_name]
                for (let i = 0; i < Object.keys(arr).length; i++) {
                    obj = {}
                    Object.keys(arr[i]).forEach((value) => {
                        obj[value] = arr[i][value]
                    })
                    result[arr[i][id]] = obj
                }
                return result
            }
            function load_json_to_nested_dict(obj_name, id1, id2, json){
                result = {}
                arr = json[obj_name]
                for (let i = 0; i < Object.keys(arr).length; i++) {
                    obj = {}
                    Object.keys(arr[i]).forEach((value) => {
                        obj[value] = arr[i][value]
                    })
                    if(!(result[arr[i][id1]])){
                        result[arr[i][id1]] = {}
                    }
                    result[arr[i][id1]][arr[i][id2]] = obj
                }
                return result
            }
            class Recipe{
                constructor(name, items, steps, tags){
                    this.name = name
                    this.items = items
                    this.steps = steps
                    this.tags = tags
                }

                get_rating(){
                    var result = 1
                    Object.values(this.items).forEach((item)=>{result*=item.get_total_multiplier()})
                    return result
                }

                make_div(){
                    var div = document.createElement("div")

                    var overview_div = document.createElement("div")
                    overview_div.className = "recipe_overview_div"
                    overview_div.id = "RECIPE_OVERVIEW_" + this.name

                    var name_p = document.createElement("p")
                    name_p.innerText = this.name
                    name_p.className = "recipe_name"
                    overview_div.append(name_p)

                    var rate_p = document.createElement("p")
                    rate_p.innerText = "Rating: " + Math.round(this.get_rating()*100) + "% fit"
                    rate_p.className = "recipe_rating"
                    overview_div.append(rate_p)
                    div.append(overview_div)

                    var details_div = document.createElement("div")
                    details_div.className = "recipe_details_div"
                    details_div.id = "RECIPE_DETAILS_DIV_" + this.name

                    var ingredients_div = document.createElement("div")
                    ingredients_div.className = "ingredients_div"
                    ingredients_div.id = "INGREDIENTS_DIV_" + this.name
                    Object.values(this.items).forEach((item)=>ingredients_div.append(item.make_div()))
                    details_div.append(ingredients_div)

                    div.append(details_div)
                    return div
                }
            }
            class ItemToRecipe{
                constructor(recipe, item, missing, amount, measurment){
                    this.recipe = recipe
                    this.item = item
                    this.missing = missing
                    this.amount = amount
                    this.measurment = measurment
                }

                is_missing(){
                    return this.item.get_total_multiplier() < this.missing 
                }

                get_total_multiplier(){
                    return Math.max(this.item.get_total_multiplier(), this.missing)
                }

                make_div(){
                    var div = document.createElement("div")
                    div.className = "recipe_item_div"
                    div.id = "RECIPE_ITEM_DIV_" + this.item.name

                    var amount_p = document.createElement("p")
                    amount_p.className = "recipe_item_amount"
                    amount_p.innerText = this.amount
                    div.append(amount_p)

                    var measurment_p = document.createElement("p")
                    measurment_p.className = "recipe_item_measurment"
                    measurment_p.innerText = this.measurment
                    div.append(measurment_p)

                    var name_p = document.createElement("p")
                    name_p.className = "recipe_item_name"
                    name_p.innerText = this.item.name
                    div.append(name_p)

                    var extra_p = document.createElement("p")
                    extra_p.className = "recipe_item_extra"
                    if(this.is_missing()){
                        extra_p.innerText = "(go without)"
                    }
                    else if(!this.item.get_available()){
                        extra_p.innerText = "(buy)"
                    }
                    div.append(extra_p)

                    return div
                }
            }
            class ItemType{
                constructor(name, parent, toBuy){
                    this.name = name
                    this.set_parent(parent)
                    this.toBuy = toBuy
                    this.children = []
                    this.items = []
                }

                set_parent(parent){
                    if(parent && typeof parent == "object"){
                        parent.children.push(this)
                    }
                    this.parent = parent
                }
                get_toBuy(){
                    var result = this.toBuy
                    var type = this.parent
                    while(result == null){
                        if(type == null || typeof type == "string"){
                            return 0
                        }
                        result = type.toBuy
                        type = type.parent
                    }
                    return result
                }

                toString(){
                    if(this.parent){
                        return this.parent + ", " + this.name
                    }
                    return this.name
                }

                make_div(){
                    var div = document.createElement("div")
                    div.id = "TYPE_" + this.name + "_DIV"
                    div.setAttribute("grid-area", this.name)
                    div.className = "type_div"
                    var name_p = document.createElement("p")
                    name_p.innerText = this.name
                    div.append(name_p)
                    this.items.forEach((item)=>{div.append(item.make_div())})
                    this.children.forEach((child)=>{div.append(child.make_div())})
                    return div
                }
            }
            class Item{
                
                constructor(name, type, toBuy, allergen){
                    this.name = name
                    this.set_type(type)
                    this.toBuy = toBuy
                    this.allergen = allergen
                    
                    this.available_input = document.createElement("input")
                    this.available_input.type = "checkbox"
                    this.available_input.className = "available"
                    this.available_input.id = "ITEM_AVAILABLE_" + this.name
                    this.available_input.checked = true

                    this.preferred_input = document.createElement("input")
                    this.preferred_input.type = "radio"
                    this.preferred_input.className = "preference_radio"
                    this.preferred_input.name = "ITEM_PREFERENCE_" + this.name
                    this.preferred_input.id = "ITEM_PREFERENCE_" + this.name + "_PREFFERED"
                    this.preferred_input.value = 1.5

                    this.neutural_input = document.createElement("input")
                    this.neutural_input.type = "radio"
                    this.neutural_input.className = "preference_radio"
                    this.neutural_input.name = "ITEM_PREFERENCE_" + this.name
                    this.neutural_input.id = "ITEM_PREFERENCE_" + this.name + "_NEUTURAL"
                    this.neutural_input.checked = true
                    this.neutural_input.value = 1

                    this.disliked_input = document.createElement("input")
                    this.disliked_input.type = "radio"
                    this.disliked_input.className = "preference_radio"
                    this.disliked_input.name = "ITEM_PREFERENCE_" + this.name
                    this.disliked_input.id = "ITEM_PREFERENCE_" + this.name + "_DISLIKED"
                    this.disliked_input.value = 0.5

                    this.exclude_input = document.createElement("input")
                    this.exclude_input.type = "radio"
                    this.exclude_input.className = "preference_radio"
                    this.exclude_input.name = "ITEM_PREFERENCE_" + this.name
                    this.exclude_input.id = "ITEM_PREFERENCE_" + this.name + "_EXPLUDE"
                    this.exclude_input.value = 0

                    this.preferred_div = document.createElement("div")
                    this.preferred_div.id = "ITEM_PREFERENCE_DIV_" + this.name
                    this.preferred_div.className = "preference_div"
                    this.preferred_div.append(this.preferred_input)
                    this.preferred_div.append(this.neutural_input)
                    this.preferred_div.append(this.disliked_input)
                    this.preferred_div.append(this.exclude_input)

                    this.available_input.onchange = ()=>{set_recepies_html(null)}
                    this.preferred_input.onchange = ()=>{set_recepies_html(null)}
                    this.neutural_input.onchange = ()=>{set_recepies_html(null)}
                    this.disliked_input.onchange = ()=>{set_recepies_html(null)}
                    this.exclude_input.onchange = ()=>{set_recepies_html(null)}
                }

                set_type(type){
                    if(type && typeof type == "object"){
                        type.items.push(this)
                    }
                    this.type = type
                }

                get_toBuy(){
                    if (this.toBuy){
                        return this.toBuy
                    }
                    if (this.type){
                        return this.type.get_toBuy()
                    }
                    return 0
                }

                get_available(){
                    return this.available_input.checked
                }

                get_prefence_multiplier(){
                    return document.querySelector("input[name=\"ITEM_PREFERENCE_" + this.name + "\"]:checked").value
                }

                get_total_multiplier(){
                    var result = this.get_prefence_multiplier()
                    if(!this.get_available()){
                        if(get_store_available()){
                            result *= this.get_toBuy()
                        }
                        else{
                            result = 0
                        }
                    }
                    return result
                }

                make_div(){
                    var div = document.createElement("div")
                    div.id = "ITEM_"+this.name
                    div.className = "item_div"

                    div.append(this.available_input)

                    var name_p = document.createElement("p")
                    name_p.id = div.id+"_name"
                    name_p.className = "item_name"
                    name_p.innerText = this.name
                    if(this.allergen){
                        name_p.innerText += " (" + this.allergen + ")"
                    }
                    div.append(name_p)

                    div.append(this.preferred_div)

                    return div
                }
            }
        </script>
    </head>
    <body onload="on_load()">
        <input type="checkbox" id="store_available" checked onchange="set_recepies_html(null)">
        <div id="items">

        </div>
        <div id="recipes">

        </div>
    </body>
</html>